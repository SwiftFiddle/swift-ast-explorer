---
format_version: '8'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: other
workflows:
  deploy:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@4: {}
    - script@1:
        title: Deploy
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            export NSUnbufferedIO=YES

            docker login --username kishikawakatsumi --password $DOCKER_HUB_ACCESS_TOKEN
            docker build --rm -t kishikawakatsumi/swift-ast-explorer.
            docker push kishikawakatsumi/swift-ast-explorer

            echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa

            ssh -t kishikawakatsumi@34.82.92.235 <<EOC
            set -ex
            hostname

            cd "\$HOME/app"
            git pull --rebase origin master

            dc='docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "\$PWD:\$PWD" -w="\$PWD" docker/compose:1.27.4'
            eval \$dc pull
            eval \$dc up --detach

            docker image prune --force
            EOC
trigger_map:
- push_branch: master
  workflow: deploy
