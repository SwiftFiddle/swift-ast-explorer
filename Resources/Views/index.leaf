<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta property="og:title" content="Swift AST Explorer">
  <meta property="og:description" content="Swift AST Explorer - AST visualizer for Swift source code" />
  <meta property="og:site_name" content="Swift AST Explorer - AST visualizer for Swift source code" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gijgo/1.9.13/combined/css/gijgo.min.css"
    integrity="sha512-oCuecFHHGu/Y4zKF8IoSoj5hQq1dLNIiUCwN08ChNW1VoMcjIIirAJT2JmKlYde6DeLN6JRSgntz6EDYDdFhCg=="
    crossorigin="anonymous" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.2.6/themes/light-border.css"
    integrity="sha256-Fev9TKDfIZRihMeo+VloYBQ6vG1Pehn17SF0wQE1w/0=" crossorigin="anonymous">

  <link rel="stylesheet" href="css/syntax.css" type="text/css" />
  <link rel="stylesheet" href="css/ui.css" type="text/css" />

  <link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="images/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="\#ffffff">
  <meta name="msapplication-TileImage" content="images/ms-icon-144x144.png">
  <meta name="theme-color" content="\#ffffff">

  <style type="text/css">
    .ace_editor {
      height: 750px;
      padding: 0;
      margin: 0;
    }

    .no-gutters {
      margin-right: 0;
      margin-left: 0;

      >.col,
      >[class*="col-"] {
        padding-right: 0;
        padding-left: 0;
      }
    }

    \#results {
      font-family: menlo;
      font-size: 10pt;
    }

    /* Sticky footer styles */
    html {
      position: relative;
      min-height: 100%;
    }

    body {
      margin-bottom: 60px;
      /* Margin bottom by footer height */
    }

    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 60px;
      /* Set the fixed height of the footer here */
      line-height: 60px;
      /* Vertically center the text there */
      background-color: \#F7F7F7;
    }
  </style>

  <script src="https://kit.fontawesome.com/e4cc3576fb.js" crossorigin="anonymous"></script>

  <title>Swift AST Explorer</title>
</head>

<body style="background-color: \#F5F5F5; color: \#333333;">
  <div class="container-fluid" style="margin-top: 10px;">
    <div class="row">
      <div class="col" style="margin-bottom: 0;">
        <a href="/" class="text-reset text-decoration-none">
          <h4><i class="fab fa-swift fa-lg" style="color: \#F05138;"></i> Swift AST Explorer</h4>
        </a>
      </div>
      <div class="col-md-6" style="margin-top: -4px;">
        <div class="p-1">
          <ul class="nav nav-tabs lined text-center">
            <li class="nav-item" style="width: 140px;">
              <a href="\#tab1" class="nav-link py-1 active" data-toggle="tab">
                <h6 style="font-size: large;"><i class="far fa-folder-tree"></i> Structure</h6>
              </a>
            </li>
            <li class="nav-item" style="width: 140px;">
              <a href="\#tab2" class="nav-link py-1" data-toggle="tab">
                <h6 style="font-size: large;"><i class="fal fa-file-code"></i> Syntax</h6>
              </a>
            </li>
            <li class="nav-item" style="width: 140px;">
              <a href="\#tab3" class="nav-link py-1" data-toggle="tab">
                <h6 style="font-size: large;"><i class="fas fa-question-circle"></i> Help</i></h6>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="container-fluid" style="padding-right: 0; padding-left: 0; padding-bottom: 15px;">
    <div class="row no-gutters">
      <div class="col-md-6">
        <pre id="editor">#(defaultSampleCode)</pre>
      </div>
      <div class="col-md-6" style="height: 750px; overflow: scroll; font-family: Helvetica; font-size: 11pt;">
        <div class="tab-content" style="background: \#FAFAFA;">
          <div id="tab1" class="tab-pane active">
            <div id="structure" style="font-family: menlo; font-size: 11pt;"></div>
          </div>
          <div id="tab2" class="tab-pane">
            <div id="results"></div>
          </div>
          <div id="tab3" class="tab-pane" style="background: \#F5F5F5;">
            <div class="my-4 mx-2" role="document">
              <div class="col-12">
                <div style="font-size: large;">
                  <dl>
                    <dt>Swift Version</dt>
                  </dl>
                  <dd>
                    <pre><code>#(swiftVersion)</code></pre>
                  </dd>
                  <dl>
                    <dt>Import</dt>
                    <dd>There are a few different ways to import code into Playground:</dd>
                  </dl>
                  <ul>
                    <li>Drop a file onto the editor</li>
                    <li>Append a GitHub gist ID to the URL<br>(e.g. <code>swift-ast-explorer.com/<code
                          style=" background-color: \#F0F0F0; padding: 2px;">&lt;gist_id_goes_here&gt;</code></code>)
                    </li>
                    <li>Or just start typing!</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-3 mx-auto" style="margin-top: 20px; margin-bottom: 20px;">
        <button id="run-button" type="button" class="btn btn-secondary btn-block btn-lg">
          <span id="run-button-text">Update <i class="fas fa-chevron-right align-baseline"></i></span> <span
            id="run-button-spinner" class="spinner-border spinner-border-sm"
            style="width: 1.5rem; height: 1.5rem; display: none;" role="status" aria-hidden="true"></span></button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="mx-auto">
          <a href="https://github.com/kishikawakatsumi/swift-ast-explorer" style="color: \#999999;"><i
              class="fa fa-github fa-2x"></i></a>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"
    integrity="sha512-GoORoNnxst42zE3rYPj4bNBm0Q6ZRXKNH2D9nEmNvVF/z24ywVnijAWVi/09iBiVDQVf3UlZHpzhAJIdd9BXqw=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.min.js"
    integrity="sha512-8qx1DL/2Wsrrij2TWX5UzvEaYOFVndR7BogdpOyF4ocMfnfkw28qt8ULkXD9Tef0bLvh3TpnSAljDC7uyniEuQ=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-xcode.min.js"
    integrity="sha512-S3wipD42Bs0Dthj5mI3YkgHBB60mCkmID1qcxv4GZXV/bVivb9PIvEEBwTeIQTcZXUHo4aj7CktRhA/c2k7ftQ=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-terminal.min.js"
    integrity="sha512-Tw4o9yJl67xiLPUU5do1oSzDGys0tLrb8NMcVP25Pn6VWRfJART2nZ/X2p9ocWpNcs3jbO2fnnBJmFJzlZ1k1Q=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-swift.min.js"
    integrity="sha512-5NanghFVFTJf0tjHV2hWFuF/r9LuNKq9c0Pcs+TF7vWuD0AavR6az6X/vLW1AvLCo/AZg6EIBtm2WzLKNleDAQ=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gijgo/1.9.13/combined/js/gijgo.min.js"
    integrity="sha512-T62eI76S3z2X8q+QaoTTn7FdKOVGjzKPjKNHw+vdAGQdcDMbxZUAKwRcGCPt0vtSbRuxNWr/BccUKYJo634ygQ=="
    crossorigin="anonymous"></script>

  <script type="text/javascript">
    function showLoading() {
      $("\#run-button").addClass("disabled");
      $("\#run-button-text").hide();
      $("\#run-button-spinner").show();
    }

    function hideLoading() {
      $("\#run-button").removeClass("disabled");
      $("\#run-button-text").show();
      $("\#run-button-spinner").hide();
    }
  </script>

  <script type="text/javascript">
    ace.require("ace/ext/language_tools");

    const editor = ace.edit("editor");
    editor.setTheme("ace/theme/xcode");
    editor.session.setMode("ace/mode/swift");
    editor.$blockScrolling = Infinity
    editor.setOptions({
      useSoftTabs: true,
      autoScrollEditorIntoView: true,
      fontFamily: "menlo",
      fontSize: "10pt",
      showInvisibles: false,
      enableBasicAutocompletion: true,
      enableSnippets: true,
      enableLiveAutocompletion: true,
    });
    editor.renderer.setOptions({
      showFoldWidgets: false,
      showPrintMargin: false,
    });
    const row = editor.session.getLength() - 1
    const column = editor.session.getLine(row).length
    editor.gotoLine(row + 1, column)

    const results = $("\#results");
    let tree = null;

    $("\#run-button").click(function (e) {
      e.preventDefault();
      update(editor)
    });

    function update(editor) {
      showLoading();

      const code = editor.getValue();
      const json = {
        code: code
      };
      $.post('/update', json, function (data, xhr) {
        function unescapeHTML(str) {
          let div = document.createElement("div");
          div.innerHTML = str.replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
          return div.textContent || div.innerText;
        }
        results.html(unescapeHTML(data.syntaxHTML));

        if (tree) {
          tree.destroy();
        }
        tree = $('\#structure').tree({
          dataSource: JSON.parse(data.syntaxJSON)
        });

        const children = tree.getChildren(tree)
        for (let i = 0, len = children.length; i < Math.min(len, 100); i++) {
          tree.expand(tree.getNodeById(children[i]));
        }

        hideLoading();

        $('\#structure').find('li').each(function (i, e) {
          const id = $(e).attr('data-id');
          const data = tree.getDataById(id);
          if (data.token) {
            e.style.fontWeight = 'bold';
          }

          $(this).mouseover(function (e) {
            const id = $(this).attr('data-id');

            const node = tree.getNodeById(id);
            tree.select(node);
            if (data.token) {
              const target = $(this).find("[data-role='display']");
              if (!target.attr('__tippy')) {
                tippy($(this).find("[data-role='display']")[0], {
                  content: `<span class='tooltip-text'>kind:</span><span style='font-family: "Menlo", sans-serif, monospace;'> ${data.token.kind}</span><br><span class='tooltip-text'>leadingTrivia:</span><span style='font-family: "Menlo", sans-serif, monospace;'> ${data.token.leadingTrivia}</span><br><span class='tooltip-text'>text:</span><span style='font-family: "Menlo", sans-serif, monospace;'> ${data.text}</span><br><span class='tooltip-text'>trailingTrivia:</span><span style='font-family: "Menlo", sans-serif, monospace;'> ${data.token.trailingTrivia}</span>`,
                  allowHTML: true,
                  placement: 'auto',
                  theme: 'light-border',
                });
                target.attr('__tippy', true);
              }
            }

            const Range = ace.require("ace/range").Range;
            editor.selection.setRange(new Range(data.range.startRow, data.range.startColumn,
              data.range
              .endRow, data.range.endColumn));

            e.stopPropagation();
          });
          $(this).mouseout(function (e) {
            tree.unselectAll();
          });
        });

        let visibleTooltips = []
        $('\#results').find('span').each(function (i, e) {
          $(this).mouseover(function (e) {
            let element = e.target;
            element.style.backgroundColor = 'rgba(81, 101, 255, 0.5)';

            if (!element.getAttribute('__tippy')) {
              const tooltip = tippy(element, {
                content: `<span style='font-family: "Menlo", sans-serif, monospace;'>${element.dataset.tooltipContent}</span>`,
                allowHTML: true,
                placement: 'left',
                theme: 'light-border',
                onShow(instance) {
                  visibleTooltips.push(instance);
                },
                onHidden(instance) {
                  visibleTooltips = visibleTooltips.filter(e => e !== instance);
                },
              });
              element.setAttribute('__tippy', true);
            }

            $(this).parents('span').each(function (i, e) {
              if (!e.getAttribute('__tippy')) {
                const tooltip = tippy(element, {
                  content: `<span style='font-family: "Menlo", sans-serif, monospace;'>${e.dataset.tooltipContent}</span>`,
                  allowHTML: true,
                  placement: 'left',
                  theme: 'light-border',
                  onShow(instance) {
                    visibleTooltips.push(instance);
                    const placements = ['left', 'bottom', 'right'];
                    visibleTooltips.forEach((tooltip, i) => {
                      tooltip.setProps({
                        placement: placements[i % placements.length],
                        offset: [0 + (20 * ((i / placements.length) ^ 0)), 20],
                      });
                    })
                  },
                  onHidden(instance) {
                    visibleTooltips = visibleTooltips.filter(e => e !== instance);
                  },
                });
                e.setAttribute('__tippy', true);
                tooltip.show();
              }

              createDOMRectElement(e.getBoundingClientRect())
              if (i > 0) {
                return false
              }

              function createDOMRectElement(domRect) {
                let rectElements = document.getElementsByClassName('dom-rect');
                for (let i = 0, l = rectElements.length; l > i; i++) {
                  rectElements[0].parentNode.removeChild(rectElements[0]);
                }

                let rectElement = document.createElement('div');
                rectElement.className = 'dom-rect';
                rectElement.style.left = (domRect.x - 1) + 'px';
                rectElement.style.top = (domRect.y - 1) + 'px';
                rectElement.style.width = domRect.width + 'px';
                rectElement.style.height = domRect.height + 'px';
                rectElement.style.pointerEvents = 'none';
                rectElement.style.position = 'absolute';
                rectElement.style.border = '1px solid rgb(81, 101, 255)';
                rectElement.style.backgroundColor = 'rgba(81, 101, 255, 0.25)';
                document.body.appendChild(rectElement);
              }
            });

            e.stopPropagation();
          });
          $(this).mouseout(function (e) {
            let element = e.target;
            element.style.backgroundColor = '';

            let rectElements = document.getElementsByClassName('dom-rect');
            for (let i = 0, l = rectElements.length; l > i; i++) {
              rectElements[0].parentNode.removeChild(rectElements[0]);
            }
          });
        });

        editor.focus();
      });
    }

    update(editor)
  </script>
  <script>
    function handleFileSelect(event) {
      event.stopPropagation();
      event.preventDefault();

      const files = event.dataTransfer.files;
      const reader = new FileReader();
      reader.onload = (event) => {
        const editor = ace.edit("editor");
        editor.setValue(event.target.result);
        editor.clearSelection();
      }
      reader.readAsText(files[0], "UTF-8");
    }

    function handleDragOver(event) {
      event.stopPropagation();
      event.preventDefault();
      event.dataTransfer.dropEffect = 'copy';
    }

    const dropZone = document.getElementById('editor');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);
  </script>
</body>

</html>